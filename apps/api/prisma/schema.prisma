// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

// Merchant (API key holder)
model Merchant {
  id        String   @id @default(uuid())
  name      String
  apiKey    String   @unique
  apiSecret String   // Hashed secret for validation
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users     User[]
  wallets   Wallet[]
  payouts   Payout[]

  @@index([apiKey])
  @@index([active])
}

// User (merchant's end users/recipients)
model User {
  id          String   @id @default(uuid())
  merchantId  String
  email       String
  firstName   String
  lastName    String
  phoneNumber String?
  metadata    Json?    // Flexible metadata storage
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  merchant        Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  wallets         Wallet[]
  identity        IdentityVerification?
  ledgerEntries   LedgerEntry[]
  balanceSnapshot BalanceSnapshot?

  @@unique([merchantId, email])
  @@index([merchantId])
  @@index([email])
}

// Wallet (per user, linked to Coinbase CDP)
model Wallet {
  id              String   @id @default(uuid())
  userId          String
  merchantId      String
  currency        String   // 'USDC' or 'USDT'
  address         String   // Coinbase CDP wallet address
  coinbaseWalletId String? // Coinbase CDP wallet ID
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  merchant        Merchant          @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  ledgerEntries   LedgerEntry[]
  balanceSnapshot BalanceSnapshot?
  payouts         Payout[]
  transactions   Transaction[]

  @@unique([userId, currency]) // One wallet per currency per user
  @@index([userId])
  @@index([merchantId])
  @@index([address])
}

// ============================================================================
// LEDGER (Source of Truth - Most Important)
// ============================================================================

// LedgerEntry - Records ALL money movements
// This is the immutable audit log of all balance changes
model LedgerEntry {
  id            String   @id @default(uuid())
  walletId      String
  userId        String
  merchantId    String
  entryType     LedgerEntryType
  amount        String   // Decimal string to avoid floating point issues
  currency      String   // 'USDC' or 'USDT'
  
  // Operation tracking
  idempotencyKey String? @unique // For idempotent operations
  operationId   String? // Links related entries (e.g., lock + settle)
  
  // Metadata
  description   String?
  metadata      Json?    // Flexible metadata (transaction hash, provider ref, etc.)
  
  // Balance state after this entry
  balanceAfter  String   // Decimal string - balance after this entry
  
  // Timestamps
  createdAt     DateTime @default(now())

  // Relations
  wallet        Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([walletId, createdAt])
  @@index([userId])
  @@index([merchantId])
  @@index([idempotencyKey])
  @@index([operationId])
  @@index([entryType])
}

// Ledger entry types
enum LedgerEntryType {
  CREDIT       // Inbound payment received
  DEBIT        // Outbound payment sent
  LOCK         // Funds locked for payout
  SETTLE       // Locked funds settled (payout completed)
  RELEASE      // Locked funds released (payout failed/cancelled)
  ADJUSTMENT   // Manual adjustment (admin only)
}

// BalanceSnapshot - Current balance state per wallet (for fast queries)
// This is a materialized view that must always be consistent with LedgerEntry
model BalanceSnapshot {
  id            String   @id @default(uuid())
  walletId      String   @unique
  userId        String
  merchantId    String
  currency      String
  
  // Balance components
  available     String   @default("0") // Available for use
  locked        String   @default("0") // Locked for pending operations
  total         String   @default("0") // available + locked
  
  // Audit
  lastEntryId   String?  // ID of last LedgerEntry that updated this snapshot
  updatedAt     DateTime @default(now()) @updatedAt

  // Relations
  wallet        Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([merchantId])
  @@index([walletId])
}

// IdempotencyKey - Track idempotency keys to prevent duplicate operations
model IdempotencyKey {
  id            String   @id @default(uuid())
  key           String   @unique
  merchantId    String
  operationType String   // 'payout', 'transfer', etc.
  
  // Request/Response caching
  status        String   // 'pending', 'completed', 'failed'
  statusCode    Int?
  requestBody   Json?
  responseBody  Json?
  
  // Timestamps
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  @@index([key])
  @@index([merchantId])
  @@index([status])
}

// ============================================================================
// PAYOUTS
// ============================================================================

// Payout - Outbound stablecoin â†’ fiat
model Payout {
  id              String   @id @default(uuid())
  walletId        String
  userId          String
  merchantId      String
  idempotencyKey  String   @unique
  
  // Payout details
  amount          String   // Decimal string
  currency        String   // 'USDC' or 'USDT'
  status          PayoutStatus @default(PENDING)
  
  // Recipient details
  recipientAccount String
  recipientName    String
  recipientBankCode String?
  
  // Provider tracking
  providerId      String?  // Zerocard payout ID
  providerRef     String?  // Provider reference
  
  // Metadata
  metadata       Json?
  
  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  completedAt    DateTime?

  // Relations
  wallet         Wallet   @relation(fields: [walletId], references: [id], onDelete: Restrict)
  merchant       Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([userId])
  @@index([merchantId])
  @@index([status])
  @@index([idempotencyKey])
  @@index([providerId])
}

enum PayoutStatus {
  PENDING     // Created, funds locked
  PROCESSING  // Sent to provider
  COMPLETED   // Successfully completed
  FAILED      // Failed, funds released
  CANCELLED   // Cancelled, funds released
}

// ============================================================================
// TRANSACTIONS (Inbound Payments)
// ============================================================================

// Transaction - Inbound stablecoin payment
model Transaction {
  id            String   @id @default(uuid())
  walletId      String
  userId        String
  merchantId    String
  
  // Transaction details
  amount        String   // Decimal string
  currency      String   // 'USDC' or 'USDT'
  status        TransactionStatus @default(PENDING)
  
  // Blockchain details
  txHash        String?  @unique
  blockNumber   BigInt?
  confirmations Int      @default(0)
  
  // Provider tracking
  providerId    String?  // Coinbase CDP transaction ID
  providerRef   String?
  
  // Metadata
  metadata      Json?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  confirmedAt   DateTime?

  // Relations
  wallet        Wallet   @relation(fields: [walletId], references: [id], onDelete: Restrict)

  @@index([walletId])
  @@index([userId])
  @@index([merchantId])
  @@index([status])
  @@index([txHash])
  @@index([providerId])
}

enum TransactionStatus {
  PENDING     // Detected but not confirmed
  CONFIRMED   // Confirmed on blockchain
  FAILED      // Failed transaction
}

// ============================================================================
// IDENTITY / KYC
// ============================================================================

// IdentityVerification - KYC status
model IdentityVerification {
  id            String   @id @default(uuid())
  userId        String   @unique
  merchantId    String
  
  // KYC status
  status        KYCStatus @default(PENDING)
  level         String?   // 'basic', 'enhanced', etc.
  
  // Provider tracking
  providerId    String?   // KYC provider ID
  providerRef  String?
  
  // Verification data
  data         Json?     // Provider-specific data
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  verifiedAt   DateTime?

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([merchantId])
  @@index([status])
}

enum KYCStatus {
  PENDING     // Not verified
  VERIFIED    // Verified
  REJECTED    // Verification rejected
  EXPIRED     // Verification expired
}

// ============================================================================
// WEBHOOKS
// ============================================================================

// WebhookEvent - Webhook dispatch tracking
model WebhookEvent {
  id            String   @id @default(uuid())
  merchantId    String
  
  // Event details
  eventType     String   // 'payout.completed', 'transaction.confirmed', etc.
  payload       Json
  
  // Delivery tracking
  status        WebhookStatus @default(PENDING)
  attempts      Int      @default(0)
  lastAttemptAt DateTime?
  nextRetryAt   DateTime?
  
  // Response
  responseCode  Int?
  responseBody  String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  deliveredAt   DateTime?

  @@index([merchantId])
  @@index([status])
  @@index([eventType])
  @@index([nextRetryAt])
}

enum WebhookStatus {
  PENDING     // Not yet sent
  DELIVERED   // Successfully delivered
  FAILED      // Failed after all retries
  RETRYING    // Currently retrying
}
